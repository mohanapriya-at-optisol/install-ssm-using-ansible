name: Install SSM Agent with Ansible
on:
  push:
    branches:
      - main
      

jobs:
  install-ssm:
    runs-on: self-hosted
    env:
      SERVER_IPS: ${{ secrets.SERVER_IPS }}
      SSH_USERS: ${{ secrets.SSH_USERS }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create SSH Keys and Inventory
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          
          cat > inventory.ini << EOF
          [servers]
          EOF
          
          # Parse arrays
          IFS=',' read -ra IPS <<< "$SERVER_IPS"
          IFS=',' read -ra USERS <<< "$SSH_USERS"
          
          # Check if using single key or multiple keys
          if [ -n "$SSH_PRIVATE_KEY" ]; then
            echo "Using single SSH key for all servers"
            
            # Create single SSH key file
            echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            
            # Test SSH key
            if ssh-keygen -l -f ~/.ssh/id_rsa >/dev/null 2>&1; then
              echo "✓ SSH key is valid"
            else
              echo "✗ SSH key is invalid - check format in GitHub Secrets"
            fi
            
            # Add all servers with same key
            counter=1
            for i in "${!IPS[@]}"; do
              ip="${IPS[i]}"
              user="${USERS[i]}"
              echo "server${counter} ansible_host=${ip} ansible_user=${user} ansible_ssh_private_key_file=~/.ssh/id_rsa" >> inventory.ini
              ((counter++))
            done
            
          else
            echo "Using multiple SSH keys for servers"
            
            # Create multiple SSH key files
            counter=1
            for i in "${!IPS[@]}"; do
              ip="${IPS[i]}"
              user="${USERS[i]}"
              
              # Get SSH key for this server
              key_var="SSH_KEY_${counter}"
              key_content="${!key_var}"
              
              if [ -z "$key_content" ]; then
                echo "Warning: SSH_KEY_${counter} is empty or not set"
                continue
              fi
              
              echo "Processing SSH_KEY_${counter} for ${ip}..."
              
              # Create SSH key file for this server
              echo "$key_content" > ~/.ssh/id_rsa_server${counter}
              chmod 600 ~/.ssh/id_rsa_server${counter}
              
              # Test SSH key
              if ssh-keygen -l -f ~/.ssh/id_rsa_server${counter} >/dev/null 2>&1; then
                echo "✓ SSH key ${counter} is valid"
              else
                echo "✗ SSH key ${counter} is invalid - check format in GitHub Secrets"
              fi
              
              # Add to inventory
              echo "server${counter} ansible_host=${ip} ansible_user=${user} ansible_ssh_private_key_file=~/.ssh/id_rsa_server${counter}" >> inventory.ini
              ((counter++))
            done
          fi
          
          cat >> inventory.ini << EOF
          
          [all:vars]
          ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          EOF
          
          echo "Generated inventory:"
          cat inventory.ini

      - name: Install Ansible and Collections
        run: |
          sudo apt update
          sudo apt install -y ansible
          ansible-galaxy collection install amazon.aws
          ansible-galaxy collection install community.general

      - name: Run Ansible Playbook
        run: |
          ansible-playbook -i inventory.ini install-ssm.yml

      - name: Cleanup SSH Keys and Inventory
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa ~/.ssh/id_rsa_server*
          rm -f inventory.ini
          echo "SSH keys and inventory files deleted"
